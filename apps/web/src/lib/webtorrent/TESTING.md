# WebTorrent P2P 功能测试指南

## 当前可测试功能（Phase 1 + 2）

✅ 房主做种和本地播放
❌ 观众下载（Phase 3 待实现）
❌ WebSocket 信令（Phase 4 待实现）

---

## 测试环境准备

### 1. 启动开发服务器

```bash
cd apps/web
pnpm dev
```

### 2. 准备测试视频

准备一个本地视频文件：
- **格式**: MP4, WebM, MKV, OGG
- **大小**: 建议 < 500MB（方便快速测试）
- **推荐**: 使用 MP4 格式（兼容性最好）

---

## 测试步骤

### 步骤 1: 登录并创建房间

1. 访问 http://localhost:3000
2. 点击"登录"或"注册"
3. 登录后，点击"创建房间"
4. 输入房间名称（如 "测试 P2P"）
5. 创建成功后进入房间

### 步骤 2: 上传视频文件

在房间页面中，你应该看到 **TorrentSeeder** 组件（仅房主可见）：

```
┌─────────────────────────────────────────┐
│  📁 拖拽视频文件到这里                    │
│     或点击选择文件                        │
│                                         │
│  支持 MP4, WebM, MKV, OGG 格式          │
│  最大 10 GB                             │
└─────────────────────────────────────────┘
```

**方式 1: 点击上传**
- 点击上传区域
- 选择本地视频文件

**方式 2: 拖拽上传**
- 将视频文件拖入上传区域
- 松开鼠标完成上传

### 步骤 3: 观察做种状态

文件选择后，应该看到：

1. **视频播放器显示视频** （使用本地 Blob URL）
2. **TorrentStatus 状态指示器出现**:
   ```
   ● 做种中  👥 0  ↑ 0 B/s
   ```

3. **做种状态卡片**:
   ```
   ┌─────────────────────────────────┐
   │ 🎬 正在分享视频          [×]    │
   ├─────────────────────────────────┤
   │ movie.mp4                       │
   │ 245 MB                          │
   ├─────────────────────────────────┤
   │ 连接数: 0 人  上传速度: 0 B/s   │
   │ 已上传: 0 B   InfoHash: abc1... │
   └─────────────────────────────────┘
   ```

### 步骤 4: 检查控制台输出

打开浏览器控制台（F12），应该看到：

```
[WebTorrent] Client initialized successfully
[WebTorrent] Seeding started: <infoHash>
[Room] Torrent ready: { magnetURI: "magnet:?xt=urn:btih:...", ... }
[Room] Local video ready: blob:http://localhost:3000/...
```

### 步骤 5: 测试视频播放

- ✅ 视频应该自动加载到播放器
- ✅ 可以点击播放按钮播放视频
- ✅ 可以拖动进度条（本地播放）
- ✅ 视频控制按钮正常工作

---

## 预期结果 ✅

### 成功标志

1. **上传成功**
   - ✅ 文件验证通过
   - ✅ 没有报错

2. **做种成功**
   - ✅ 控制台输出 `Seeding started`
   - ✅ 生成 magnet URI
   - ✅ TorrentStatus 显示 "做种中"

3. **本地播放成功**
   - ✅ 视频加载到播放器
   - ✅ 可以正常播放
   - ✅ 控制功能正常

4. **状态显示正常**
   - ✅ 做种卡片显示文件信息
   - ✅ 上传速度为 0（暂无观众）
   - ✅ 连接数为 0（暂无观众）

---

## 常见问题排查

### 问题 1: 看不到 TorrentSeeder 组件

**原因**: 你可能不是房主

**解决**:
- 确保你创建了房间（而不是加入别人的房间）
- 检查 `room.currentUserRole === 'host'`

### 问题 2: 文件上传后没反应

**检查**:
1. 打开浏览器控制台查看错误
2. 确认文件格式是否支持
3. 检查文件大小是否超过 10GB

### 问题 3: 控制台报错 "WebTorrent can only be used in browser"

**原因**: SSR 问题

**解决**:
- 确认 `"use client"` 指令存在
- 清除 `.next` 缓存重新构建

### 问题 4: 视频无法播放

**检查**:
1. 浏览器是否支持该视频格式
2. 控制台是否有错误
3. 视频文件是否损坏

### 问题 5: WebTorrent 初始化失败

**可能原因**:
- 网络环境阻止 WebRTC
- Tracker 服务器无法访问

**解决**:
- 检查网络连接
- 查看 `lib/webtorrent/config.ts` 中的 tracker 列表
- 尝试使用 VPN

---

## 高级测试

### 测试 1: 大文件警告

上传 > 2GB 的文件，控制台应该输出警告：
```
文件较大 (2.5 GB)，做种可能占用较多带宽
```

### 测试 2: 格式验证

尝试上传非视频文件（如 .txt），应该看到错误提示：
```
不支持的视频格式，请上传 MP4, WebM, MKV 或 OGG 格式
```

### 测试 3: 停止做种

点击做种卡片右上角的 [×] 按钮：
- ✅ 做种停止
- ✅ 状态卡片消失
- ✅ 恢复上传界面

### 测试 4: WebTorrent 客户端单例

打开控制台执行：
```javascript
// 导入客户端（需要在浏览器环境）
const { getWebTorrentClient } = await import('/src/lib/webtorrent/client.ts');
const client = await getWebTorrentClient();

console.log('Torrents:', client.torrents);
console.log('Download speed:', client.downloadSpeed);
console.log('Upload speed:', client.uploadSpeed);
```

---

## 下一步测试（待 Phase 3 完成）

⏳ **观众下载测试**:
1. 房主上传视频并做种
2. 观众通过 magnet URI 下载
3. 观众边下边播

⏳ **多人 P2P 测试**:
1. 一个房主 + 多个观众
2. 观众之间互相传输
3. 测试分发效率

⏳ **播放同步测试**:
1. 房主控制播放
2. 观众同步播放状态

---

## 测试反馈

如果遇到问题，请记录：
- 浏览器版本
- 操作系统
- 视频文件信息（格式、大小）
- 完整的控制台错误日志
- 复现步骤
